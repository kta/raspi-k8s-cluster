---
- name: Verify Kubernetes Cluster Health & HA Status
  hosts: primary_master
  become: yes
  tasks:
    # ---------------------------------------------------
    # 1. ãƒãƒ¼ãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª (3å°ã¨ã‚‚ Ready ã‹ï¼Ÿ)
    # ---------------------------------------------------
    - name: Wait for all 3 nodes to become Ready (Max 2 mins)
      shell: kubectl get nodes --no-headers | grep -w "Ready" | wc -l
      register: ready_nodes_count
      # 3å°ãŒReadyã«ãªã‚‹ã¾ã§ã€10ç§’ãŠãã«12å›ãƒã‚§ãƒƒã‚¯ã™ã‚‹
      until: ready_nodes_count.stdout | int == 3
      retries: 12
      delay: 10
      changed_when: false

    - name: Assert that 3 nodes are Ready
      assert:
        that:
          - ready_nodes_count.stdout | int == 3
        fail_msg: "âŒ Failed: Expected 3 Ready nodes, but found {{ ready_nodes_count.stdout }}."
        success_msg: "âœ… OK: All 3 nodes are Ready."

    # ---------------------------------------------------
    # 2. ã‚·ã‚¹ãƒ†ãƒ Podã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª (CoreDNS, Flannelãªã©)
    # ---------------------------------------------------
    - name: Check system pods status (Wait for Running)
      shell: kubectl get pods -n kube-system --no-headers | grep -v "Running" | wc -l
      register: not_running_pods
      # å…¨ã¦ã®PodãŒRunningã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
      until: not_running_pods.stdout | int == 0
      retries: 20
      delay: 15
      changed_when: false
      ignore_errors: yes

    - name: Assert all system pods are running
      assert:
        that:
          - not_running_pods.stdout | int == 0
        fail_msg: "âŒ Failed: Some pods in kube-system are not running yet."
        success_msg: "âœ… OK: All system pods are running."

    # ---------------------------------------------------
    # 3. HA (Load Balancer & Keepalived) ã®å‹•ä½œç¢ºèª
    # ---------------------------------------------------
    - name: Check API Server via VIP ({{ vip }}:{{ haproxy_port }})
      uri:
        url: "https://{{ vip }}:{{ haproxy_port }}/livez"
        validate_certs: no
        return_content: yes
      register: vip_check
      until: vip_check.status == 200
      retries: 12
      delay: 5

    - name: Assert VIP connection is healthy
      assert:
        that:
          - vip_check.status == 200
          - "'ok' in vip_check.content"
        fail_msg: "âŒ Failed: Cannot access API Server via VIP. HAProxy or Keepalived might be down."
        success_msg: "âœ… OK: HAProxy & VIP are working correctly!"

    # ---------------------------------------------------
    # 4. ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±ã®è¡¨ç¤º (ã‚µãƒãƒª)
    # ---------------------------------------------------
    - name: Show Cluster Nodes
      command: kubectl get nodes -o wide
      register: nodes_out
      changed_when: false

    - name: Print Cluster Status
      debug:
        msg: 
          - "ğŸ‰ Cluster Verification Complete!"
          - "{{ nodes_out.stdout_lines }}"