---
# ★ admin.confを持ってくる専用Playbook
# 手元のターミナルで kubectl get nodes と打つと、ラズパイからの返事が返ってくるようになる
- name: Fetch kubeconfig from primary master node
  hosts: primary_master
  become: true
  tasks:
    - name: Check if kubeconfig exists
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeconfig_stat

    - name: Fail if kubeconfig does not exist
      fail:
        msg: "Kubeconfig file /etc/kubernetes/admin.conf not found. Please run cluster setup first."
      when: not kubeconfig_stat.stat.exists

    - name: Create local .kube directory
      file:
        path: "{{ lookup('env', 'HOME') }}/.kube"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: false

    - name: Fetch kubeconfig file
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: "{{ lookup('env', 'HOME') }}/.kube/config"
        flat: true
        mode: '0600'

    - name: Set kubeconfig ownership
      file:
        path: "{{ lookup('env', 'HOME') }}/.kube/config"
        owner: "{{ lookup('env', 'USER') }}"
        mode: '0600'
      delegate_to: localhost
      become: false
