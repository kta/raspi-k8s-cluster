- name: Verify Kubernetes Cluster Health & HA Status
  hosts: all_masters
  become: true
  tasks:
    # ---------------------------------------------------
    # 1. ãƒãƒ¼ãƒ‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª (3å°ã¨ã‚‚ Ready ã‹ï¼Ÿ)
    # ---------------------------------------------------
    - name: Wait for all 3 nodes to be Ready
      shell: kubectl get nodes --no-headers | grep -w "Ready" | wc -l
      register: ready_nodes_count
      until: ready_nodes_count.stdout | int == 3
      retries: 12
      delay: 10
      changed_when: false
      run_once: true

    - name: Assert that 3 nodes are Ready
      assert:
        that:
          - ready_nodes_count.stdout | int == 3
        fail_msg: "âŒ Failed: Expected 3 Ready nodes, but found {{ ready_nodes_count.stdout }}."
        success_msg: "âœ… OK: All 3 nodes are Ready."
      run_once: true

    # ---------------------------------------------------
    # 2. ã‚·ã‚¹ãƒ†ãƒ Podã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
    # ---------------------------------------------------
    - name: Check for non-running system pods
      shell: kubectl get pods -n kube-system --no-headers | grep -v "Running" | grep -v "Completed" | wc -l
      register: not_running_pods
      until: not_running_pods.stdout | int == 0
      retries: 20
      delay: 15
      changed_when: false
      ignore_errors: true
      run_once: true

    - name: Assert all system pods are running
      assert:
        that:
          - not_running_pods.stdout | int == 0
        fail_msg: "âŒ Failed: Found {{ not_running_pods.stdout }} pods in kube-system that are not Running."
        success_msg: "âœ… OK: All system pods are running."
      run_once: true

    # ---------------------------------------------------
    # 3. ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª (ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ç”¨)
    # ---------------------------------------------------
    - name: Verify Etcd Metrics (0.0.0.0:2381)
      uri:
        url: "http://127.0.0.1:2381/metrics"
        return_content: no
        status_code: 200
      register: etcd_metrics
      ignore_errors: true

    - name: Assert Etcd Metrics is accessible
      assert:
        that:
          - etcd_metrics.status == 200
        fail_msg: "âŒ Failed: IP 127.0.0.1:2381 (Etcd Metrics) unreachable on {{ inventory_hostname }}."
        success_msg: "âœ… OK: Etcd metrics accessible on {{ inventory_hostname }}."

    - name: Verify Kube-Proxy Metrics (0.0.0.0:10249)
      uri:
        url: "http://127.0.0.1:10249/metrics"
        return_content: no
        status_code: 200
      register: proxy_metrics
      ignore_errors: true

    - name: Assert Kube-Proxy Metrics is accessible
      assert:
        that:
          - proxy_metrics.status == 200
        fail_msg: "âŒ Failed: IP 127.0.0.1:10249 (Kube-Proxy Metrics) unreachable on {{ inventory_hostname }}."
        success_msg: "âœ… OK: Kube-Proxy metrics accessible on {{ inventory_hostname }}."

    # ---------------------------------------------------
    # 4. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ˜ãƒ«ã‚¹ã®ç¢ºèª
    # ---------------------------------------------------
    - name: Check Component Status (Etcd Health)
      shell: kubectl get --raw='/healthz/etcd'
      register: etcd_health
      failed_when: etcd_health.stdout != "ok"
      run_once: true

    - name: Assert Component Health
      assert:
        that:
          - etcd_health.stdout == "ok"
        fail_msg: "âŒ Failed: Etcd health check failed."
        success_msg: "âœ… OK: Etcd is healthy."
      run_once: true

    # ---------------------------------------------------
    # 5. HA (VIP) ã®å‹•ä½œç¢ºèª
    # ---------------------------------------------------
    - name: Check API Server via VIP
      uri:
        url: "https://{{ vip }}:{{ haproxy_port }}/livez"
        validate_certs: false
        return_content: true
      register: vip_check
      until: vip_check.status == 200
      retries: 12
      delay: 5
      run_once: true

    - name: Assert VIP connection is healthy
      assert:
        that:
          - vip_check.status == 200
        fail_msg: "âŒ Failed: Cannot access API Server via VIP."
        success_msg: "âœ… OK: HAProxy & VIP are working correctly!"
      run_once: true

    # ---------------------------------------------------
    # 6. çµæœè¡¨ç¤º
    # ---------------------------------------------------
    - name: Print Cluster Status
      debug:
        msg: "ğŸ‰ Cluster Verification Complete! All checks passed."
      run_once: true
