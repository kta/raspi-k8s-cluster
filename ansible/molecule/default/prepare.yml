---
# Prepare playbook - runs before converge to set up the test environment
- name: Prepare containers for testing
  hosts: all
  become: true
  gather_facts: true
  tasks:
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600
      changed_when: false

    - name: Install Python dependencies
      apt:
        name:
          - python3
          - python3-apt
          - python3-pip
        state: present

    - name: Ensure systemd is running
      command: systemctl --version
      changed_when: false
      register: systemd_version

    - name: Display systemd version
      debug:
        msg: "Systemd version: {{ systemd_version.stdout_lines[0] }}"

    - name: Create necessary directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /tmp
        - /etc/kubernetes
        - /var/lib/kubelet

    - name: Set hostname based on inventory name
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Update /etc/hosts with all nodes
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item].ansible_default_ipv4.address | default('127.0.0.1') }} {{ item }}"
        create: true
        mode: '0644'
      loop: "{{ groups['all_masters'] }}"
      when: hostvars[item].ansible_default_ipv4 is defined
