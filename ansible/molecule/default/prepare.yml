---
- name: Prepare Test Environment (Mocking Hardware)
  hosts: all
  become: true
  tasks:
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install required tools for testing
      apt:
        name: [curl, iproute2, sudo, systemd, ca-certificates]
        state: present

    # --- Hardware Mocking (ハードウェア操作の無効化) ---
    
    - name: Create dummy /boot/cmdline.txt (Prevent grep fail)
      file:
        path: /boot/cmdline.txt
        state: touch
        mode: '0644'
      failed_when: false

    - name: Create dummy /boot/firmware directory
      file:
        path: /boot/firmware
        state: directory

    - name: Create dummy /boot/firmware/cmdline.txt
      file:
        path: /boot/firmware/cmdline.txt
        state: touch
        mode: '0644'

    # --- System Command Mocking (コマンドのモック化) ---

    - name: Mock 'modprobe' command (Docker has no kernel modules)
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] modprobe $@"
          exit 0
        dest: /sbin/modprobe
        mode: '0755'

    - name: Mock 'swapoff' command
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] swapoff $@"
          exit 0
        dest: /sbin/swapoff
        mode: '0755'

    - name: Mock 'sysctl' to avoid readonly filesystem errors
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] sysctl $@"
          exit 0
        dest: /sbin/sysctl
        mode: '0755'
        force: true

    - name: Ensure /etc/fstab exists
      file:
        path: /etc/fstab
        state: touch

    # --- Kubeadm Bypass (重すぎる処理の回避) ---
    
    # kubeadm init はDocker内ではcgroup等の関係で非常に困難。
    # そこで、kubeadmコマンド自体をモック化し、「成功したふり」をさせて
    # Ansibleのフロー（ファイルの生成や変数の受け渡し）が正しく動くかを確認する。
    
    - name: Mock 'kubeadm' command
      copy:
        content: |
          #!/bin/bash
          if [[ "$@" == *"init"* ]]; then
            echo "[MOCK] kubeadm init executed"
            # ダミーのadmin.confを作成
            mkdir -p /etc/kubernetes
            touch /etc/kubernetes/admin.conf
            # ダミーのUpload cert keyを出力
            echo "1234567890abcdef1234567890abcdef"
          elif [[ "$@" == *"token create"* ]]; then
            echo "kubeadm join 172.18.0.100:8443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:1234567890abcdef"
          elif [[ "$@" == *"join"* ]]; then
             echo "[MOCK] kubeadm join executed"
             # ダミーのkubelet conf作成（参加成功の証）
             touch /etc/kubernetes/kubelet.conf
          else
            echo "[MOCK] kubeadm other command"
          fi
          exit 0
        dest: /usr/bin/kubeadm
        mode: '0755'

    - name: Mock 'kubectl' command
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] kubectl $@"
          exit 0
        dest: /usr/bin/kubectl
        mode: '0755'