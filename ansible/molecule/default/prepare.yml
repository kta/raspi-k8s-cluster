---
- name: Prepare Test Environment (Mocking Hardware)
  hosts: all
  become: true
  gather_facts: false  # 高速化のため最初はFacts収集しない
  tasks:
    # --- 1. Aptロックの解放待ち (起動直後の競合回避) ---
    - name: Wait for apt lock to be released
      raw: |
        while fuser /var/lib/dpkg/lock >/dev/null 2>&1 || fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
          echo "Waiting for apt lock..."
          sleep 2
        done
      changed_when: false

    - name: Update apt cache (with retry)
      apt:
        update_cache: true
        cache_valid_time: 3600
      register: apt_result
      until: apt_result is success
      retries: 3
      delay: 5

    - name: Install required tools for testing
      apt:
        name: [curl, iproute2, sudo, systemd, ca-certificates, procps]
        state: present

    # --- 2. Hardware Mocking (ハードウェア操作の無効化) ---
    - name: Ensure /boot/firmware directory exists
      file:
        path: /boot/firmware
        state: directory
        mode: '0755'

    - name: Create dummy cmdline.txt files
      file:
        path: "{{ item }}"
        state: touch
        mode: '0644'
      loop:
        - /boot/cmdline.txt
        - /boot/firmware/cmdline.txt

    # --- 3. System Command Mocking (コマンドのモック化) ---
    # 既存のバイナリがあると上書きでエラーになることがあるため、先に削除する
    - name: Remove existing system binaries for mocking
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /sbin/modprobe
        - /usr/sbin/modprobe
        - /sbin/swapoff
        - /usr/sbin/swapoff
        - /sbin/sysctl
        - /usr/sbin/sysctl

    # どこから呼ばれてもいいように /usr/bin, /usr/sbin 両方にモックを配置
    - name: Mock 'modprobe' (Kernel modules)
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] modprobe $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/modprobe
        - /usr/sbin/modprobe

    - name: Mock 'swapoff' (Swap)
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] swapoff $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/swapoff
        - /usr/sbin/swapoff

    - name: Mock 'sysctl' (Kernel params)
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] sysctl $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/sysctl
        - /usr/sbin/sysctl

    - name: Ensure /etc/fstab exists
      file:
        path: /etc/fstab
        state: touch

    # --- 4. Kubeadm Bypass (構築プロセスのモック化) ---
    - name: Mock 'kubeadm' command
      copy:
        content: |
          #!/bin/bash
          # ログを出力して実行されたことを証明する
          echo "[MOCK] kubeadm execution: $@" >> /tmp/kubeadm_mock.log
          
          if [[ "$@" == *"init"* ]]; then
            echo "[MOCK] kubeadm init executed"
            mkdir -p /etc/kubernetes
            touch /etc/kubernetes/admin.conf
            # 証明書キーのダミー出力
            echo "1234567890abcdef1234567890abcdef"
            
          elif [[ "$@" == *"token create"* ]]; then
            # Joinコマンドのダミー出力
            echo "kubeadm join 127.0.0.1:8443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:1234567890abcdef"
            
          elif [[ "$@" == *"join"* ]]; then
             echo "[MOCK] kubeadm join executed"
             mkdir -p /etc/kubernetes
             touch /etc/kubernetes/kubelet.conf
             
          else
            echo "[MOCK] kubeadm other command"
          fi
          exit 0
        dest: /usr/bin/kubeadm
        mode: '0755'

    - name: Mock 'kubectl' command
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] kubectl $@"
          exit 0
        dest: /usr/bin/kubectl
        mode: '0755'