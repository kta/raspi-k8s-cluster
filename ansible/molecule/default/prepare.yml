- name: Prepare Test Environment (Debian 13 Trixie)
  hosts: all
  become: true
  gather_facts: false
  tasks:
    # --- 1. APT Update & Bootstrap (最重要修正) ---
    # Pythonの有無に関わらず、必ずリポジトリを更新する。
    # rawモジュールを使って、Ansibleのaptモジュールが動く前の下地を作る。
    - name: Force Update Apt Cache
      raw: |
        # ロック解除待ち
        for i in 1 2 3 4 5; do
          if apt-get check >/dev/null 2>&1; then break; fi
          echo "Waiting for apt lock... $i"
          sleep 3
        done

        # 【重要】Debian 13用: Release Info変更を許可して更新
        # これをやらないとTesting版は更新できない
        apt-get update --allow-releaseinfo-change || apt-get update

        # 最低限のツールをインストール (Pythonは既にあるかもしれないが念のため)
        apt-get install -y python3 python3-apt sudo acl
      changed_when: false
      register: bootstrap_out
      # 失敗したらログを見せるためにエラーにする
      failed_when: bootstrap_out.rc != 0
    # --- 2. APT Configuration (恒久対策) ---
    # 以降のタスクや site.yml で apt モジュールがエラーにならないように設定
    - name: Configure Apt to allow release info changes permanently
      copy:
        content: |
          Acquire::AllowReleaseInfoChange "true";
          Acquire::AllowReleaseInfoChange::Suite "true";
        dest: /etc/apt/apt.conf.d/99allow_release_info_change
        mode: '0644'
    # --- 3. 依存ツールのインストール ---
    # キャッシュ更新済みなので update_cache: false でOK
    - name: Install required tools
      apt:
        name: [curl, iproute2, systemd, ca-certificates, procps, kmod]
        state: present
        update_cache: false
    # --- 4. Hardware Mocking (Reboot回避) ---
    - name: Ensure /boot/firmware directory exists
      file:
        path: /boot/firmware
        state: directory
        mode: '0755'
    # cgroup設定済みと誤認させる (Reboot回避)
    - name: Create mocked cmdline.txt
      copy:
        content: "console=serial0,115200 root=PARTUUID=x fsck.repair=yes rootwait cgroup_enable=memory cgroup_memory=1"
        dest: "{{ item }}"
        mode: '0644'
      loop:
        - /boot/cmdline.txt
        - /boot/firmware/cmdline.txt
    # --- 5. System Command Mocking ---
    - name: Remove existing binaries
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /sbin/modprobe
        - /usr/sbin/modprobe
        - /sbin/swapoff
        - /usr/sbin/swapoff
        - /sbin/sysctl
        - /usr/sbin/sysctl
    - name: Mock 'modprobe'
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] modprobe $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/modprobe
        - /usr/sbin/modprobe
    - name: Mock 'swapoff'
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] swapoff $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/swapoff
        - /usr/sbin/swapoff
    - name: Mock 'sysctl'
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] sysctl $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/sysctl
        - /usr/sbin/sysctl
    - name: Ensure /etc/fstab exists
      file:
        path: /etc/fstab
        state: touch

    # --- 6. Kubeadm Bypass ---
    - name: Mock 'kubeadm' command
      copy:
        content: |
          #!/bin/bash
          echo "[MOCK] kubeadm $@" >> /tmp/kubeadm_mock.log

          if [[ "$@" == *"init"* ]]; then
            echo "[MOCK] kubeadm init"
            mkdir -p /etc/kubernetes
            touch /etc/kubernetes/admin.conf
            echo "1234567890abcdef1234567890abcdef"
          elif [[ "$@" == *"token create"* ]]; then
            # Verifyを通すためにlocalhostのVIPを指定
            echo "kubeadm join 127.0.0.1:8443 --token mock --discovery-token-ca-cert-hash sha256:mock"
          elif [[ "$@" == *"join"* ]]; then
             echo "[MOCK] kubeadm join"
             mkdir -p /etc/kubernetes
             touch /etc/kubernetes/kubelet.conf
          fi
          exit 0
        dest: /usr/bin/kubeadm
        mode: '0755'
    - name: Create mock Flannel CNI manifest
      copy:
        content: |
          ---
          apiVersion: v1
          kind: Namespace
          metadata:
            name: kube-flannel
          ---
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: flannel
            namespace: kube-flannel
          ---
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: kube-flannel-ds
            namespace: kube-flannel
          spec:
            selector:
              matchLabels:
                app: flannel
            template:
              metadata:
                labels:
                  app: flannel
              spec:
                serviceAccountName: flannel
                containers:
                - name: kube-flannel
                  image: docker.io/flannel/flannel:v0.22.0
                  args:
                  - --ip-masq
                  - --kube-subnet-mgr
                  - --iface=eth0
        dest: /tmp/kube-flannel.yml
        mode: '0644'

    - name: Mock 'kubectl' command with intelligent responses
      copy:
        content: |
          #!/bin/bash
          # Intelligent kubectl mock for CI testing
          echo "[MOCK kubectl] $@" >> /tmp/kubectl_mock.log

          if [[ "$*" == *"get nodes"* ]]; then
            cat <<'EOF'
          NAME        STATUS   ROLES           AGE   VERSION
          pi-node1    Ready    control-plane   1d    v1.29.0
          pi-node2    Ready    control-plane   1d    v1.29.0
          pi-node3    Ready    control-plane   1d    v1.29.0
          EOF
            exit 0
          elif [[ "$*" == *"get node"* ]] && [[ "$*" == *"jsonpath"* ]] && [[ "$*" == *"Ready"* ]]; then
            echo "True"
            exit 0
          elif [[ "$*" == *"get pod"* ]] && [[ "$*" == *"etcd"* ]] && [[ "$*" == *"jsonpath"* ]]; then
            echo "Running"
            exit 0
          elif [[ "$*" == *"apply"* ]] && [[ "$*" == *"-f"* ]]; then
            echo "[MOCK] Applied manifest successfully"
            exit 0
          elif [[ "$*" == *"taint"* ]]; then
            echo "[MOCK] Taint removed successfully"
            exit 0
          elif [[ "$*" == *"version"* ]]; then
            echo "Client Version: v1.29.0"
            echo "Server Version: v1.29.0"
            exit 0
          else
            exit 0
          fi
        dest: /usr/bin/kubectl
        mode: '0755'

    - name: Mock CNI setup script
      copy:
        content: |
          #!/bin/bash
          # CNI setup mock for CI environment
          echo "[MOCK] CNI setup script executed"
          exit 0
        dest: /tmp/cni_setup.sh
        mode: '0755'
