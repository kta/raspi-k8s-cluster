---
- name: Prepare Test Environment (Debian 13 Trixie)
  hosts: all
  become: true
  gather_facts: false
  tasks:
    # --- 1. Python Bootstrap & Apt Fix (Debian 13 対策) ---
    - name: Bootstrap Python and Update Apt
      raw: |
        for i in 1 2 3; do
          if apt-get check >/dev/null 2>&1; then
             if apt-get update --allow-releaseinfo-change; then
                apt-get install -y python3 python3-apt sudo
                exit 0
             fi
          fi
          echo "Waiting for apt lock or update failed... retry $i"
          sleep 5
        done
        apt-get install -y python3 python3-apt sudo
      changed_when: false
      register: bootstrap_result
      failed_when: bootstrap_result.rc != 0

    # --- 2. 依存ツールのインストール ---
    - name: Install required tools
      apt:
        name: [curl, iproute2, systemd, ca-certificates, procps, kmod]
        state: present
        update_cache: false

    # --- 3. Hardware Mocking (【修正】Reboot回避の仕込み) ---
    - name: Ensure /boot/firmware directory exists
      file:
        path: /boot/firmware
        state: directory
        mode: '0755'

    # 【重要】ここを修正！
    # 空ファイルではなく「すでに設定済み」と誤認させる内容を書き込む
    # これで common_setup.sh は exit 100 (再起動) をしなくなる
    - name: Create mocked cmdline.txt with cgroup params
      copy:
        content: "console=serial0,115200 console=tty1 root=PARTUUID=... fsck.repair=yes rootwait cgroup_enable=memory cgroup_memory=1"
        dest: "{{ item }}"
        mode: '0644'
      loop:
        - /boot/cmdline.txt
        - /boot/firmware/cmdline.txt

    # アップデートによる再起動要求ファイルも消しておく
    - name: Remove reboot-required flag
      file:
        path: /var/run/reboot-required
        state: absent

    # --- 4. System Command Mocking ---
    - name: Remove existing binaries
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /sbin/modprobe
        - /usr/sbin/modprobe
        - /sbin/swapoff
        - /usr/sbin/swapoff
        - /sbin/sysctl
        - /usr/sbin/sysctl

    - name: Mock 'modprobe'
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] modprobe $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/modprobe
        - /usr/sbin/modprobe

    - name: Mock 'swapoff'
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] swapoff $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/swapoff
        - /usr/sbin/swapoff

    - name: Mock 'sysctl'
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] sysctl $@"
          exit 0
        dest: "{{ item }}"
        mode: '0755'
      loop:
        - /sbin/sysctl
        - /usr/sbin/sysctl

    - name: Ensure /etc/fstab exists
      file:
        path: /etc/fstab
        state: touch

    # --- 5. Kubeadm Bypass ---
    - name: Mock 'kubeadm' command
      copy:
        content: |
          #!/bin/bash
          echo "[MOCK] kubeadm $@" >> /tmp/kubeadm_mock.log
          
          if [[ "$@" == *"init"* ]]; then
            echo "[MOCK] kubeadm init executed"
            mkdir -p /etc/kubernetes
            touch /etc/kubernetes/admin.conf
            echo "1234567890abcdef1234567890abcdef"
            
          elif [[ "$@" == *"token create"* ]]; then
            echo "kubeadm join 127.0.0.1:8443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:1234567890abcdef"
            
          elif [[ "$@" == *"join"* ]]; then
             echo "[MOCK] kubeadm join executed"
             mkdir -p /etc/kubernetes
             touch /etc/kubernetes/kubelet.conf
             
          else
            echo "[MOCK] kubeadm other command"
          fi
          exit 0
        dest: /usr/bin/kubeadm
        mode: '0755'

    - name: Mock 'kubectl' command
      copy:
        content: |
          #!/bin/sh
          echo "[MOCK] kubectl $@"
          exit 0
        dest: /usr/bin/kubectl
        mode: '0755'