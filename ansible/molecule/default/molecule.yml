---
dependency:
  name: galaxy

driver:
  name: docker

platforms:
  # --- Node 1: Primary Master ---
  - name: pi-node1
    image: geerlingguy/docker-${MOLECULE_DISTRO:-debian12}-ansible:latest
    command: /lib/systemd/systemd
    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    groups:
      - all_masters
      - primary_master
    networks:
      - name: k8s-cluster-net
        ipv4_address: 172.18.0.101  # 本番のIP体系に似せる

  # --- Node 2: Secondary Master ---
  - name: pi-node2
    image: geerlingguy/docker-${MOLECULE_DISTRO:-debian12}-ansible:latest
    command: /lib/systemd/systemd
    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    groups:
      - all_masters
      - secondary_masters
    networks:
      - name: k8s-cluster-net
        ipv4_address: 172.18.0.102

  # --- Node 3: Secondary Master ---
  - name: pi-node3
    image: geerlingguy/docker-${MOLECULE_DISTRO:-debian12}-ansible:latest
    command: /lib/systemd/systemd
    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    groups:
      - all_masters
      - secondary_masters
    networks:
      - name: k8s-cluster-net
        ipv4_address: 172.18.0.103

provisioner:
  name: ansible
  config_options:
    defaults:
      # 人間が読める形式でログ出力
      stdout_callback: yaml
      # Docker接続ではRebootモジュールが使えないため、Rebootタスクをスキップさせる設定
      # Playbook側で tags: ['reboot'] をつけておく必要があります
      skip_tags: "reboot,firmware_check"
  inventory:
    group_vars:
      all:
        k8s_version: "1.29"  # テスト用に安定版を指定
        vip: "172.18.0.100"  # Dockerネットワーク上のVIP
        interface: "eth0"
        haproxy_port: "8443"
        node_ips: "172.18.0.101,172.18.0.102,172.18.0.103"
        # CI環境であることを知らせるフラグ
        is_ci_environment: true

verifier:
  name: ansible

scenario:
  name: default
  test_sequence:
    - dependency
    - cleanup
    - destroy
    - syntax
    - create
    - prepare  # ★ここでMockを作成
    - converge
    # - idempotence # K8s構築スクリプトは冪等性が難しいため一旦外す
    - verify
    - cleanup
    - destroy