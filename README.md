# Raspberry Pi HA Kubernetes Cluster (Ansible + Shell)

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€3å°ã® Raspberry Piï¼ˆã¾ãŸã¯ Debian/Ubuntu ã‚µãƒ¼ãƒãƒ¼ï¼‰ä¸Šã«ã€**å®Œå…¨è‡ªå‹•åŒ–**ã§ **é«˜å¯ç”¨æ€§ï¼ˆHAï¼‰Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿** ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã® Ansible Playbook ã§ã™ã€‚

## ğŸ› è¨­è¨ˆæ€æƒ³

**ã€ŒAnsibleã¯ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ‰‹é †ç®¡ç†ï¼‰ã«å¾¹ã—ã€æ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯ã¯ ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ã«é›†ç´„ã™ã‚‹ã€**

ã“ã‚Œã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

* **å …ç‰¢æ€§**: Ansible ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä»•æ§˜å¤‰æ›´ã®å½±éŸ¿ã‚’å—ã‘ã«ãã„ã€‚
* **å¯èª­æ€§**: ä½•ã‚’ã—ã¦ã„ã‚‹ã‹ï¼ˆ`kubeadm init` ç­‰ï¼‰ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¦‹ã‚Œã°ä¸€ç›®ç­ç„¶ã€‚
* **ç§»æ¤æ€§**: å°†æ¥ Ansible ã‚’ã‚„ã‚ã¦ã‚‚ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (`scripts/`) ã¯ãã®ã¾ã¾å†åˆ©ç”¨å¯èƒ½ã€‚

## âœ¨ ç‰¹å¾´

* **3 Master / 3 Worker æ§‹æˆ**: å…¨ãƒãƒ¼ãƒ‰ãŒ Control Plane ã‹ã¤ Worker ã¨ã—ã¦å‹•ä½œï¼ˆTaintè§£é™¤æ¸ˆã¿ï¼‰ã€‚
* **é«˜å¯ç”¨æ€§ (HA)**:
* **Keepalived**: ä»®æƒ³IP (VIP) ã‚’ç®¡ç†ã—ã€Master ãƒ€ã‚¦ãƒ³æ™‚ã«å³åº§ã«åˆ‡ã‚Šæ›¿ãˆã€‚
* **HAProxy**: API Server ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã€‚


* **ãƒãƒ¼ãƒˆç«¶åˆå›é¿**: HAProxy ã‚’ `8443` ã§å¾…æ©Ÿã•ã›ã€API Server (`6443`) ã¨ã®ãƒ«ãƒ¼ãƒ—ãƒ»ç«¶åˆã‚’å›é¿ã€‚
* **å®Œå…¨è‡ªå‹•åŒ–**: 1å°ç›®ã®ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã‹ã‚‰ã€2ãƒ»3å°ç›®ã®å‚åŠ ã¾ã§ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰ã§å®Œäº†ã€‚

## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```text
.
â”œâ”€â”€ inventory.ini          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€VIPå®šç¾©ãªã©ï¼‰
â”œâ”€â”€ site.yml               # æ§‹ç¯‰ç”¨ Playbookï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
â”œâ”€â”€ reset.yml              # ç ´å£Šãƒ»ãƒªã‚»ãƒƒãƒˆç”¨ Playbook
â”œâ”€â”€ README.md              # æœ¬ãƒ•ã‚¡ã‚¤ãƒ«
â””â”€â”€ scripts/               # æ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
    â”œâ”€â”€ common_setup.sh    # å…¨ãƒãƒ¼ãƒ‰å…±é€šè¨­å®š (OS, Keepalived, HAProxy)
    â””â”€â”€ primary_init.sh    # Primaryãƒãƒ¼ãƒ‰ç”¨ (Kubeadm init, Tokenç”Ÿæˆ)

```

## ğŸ›  å‰ææ¡ä»¶

* **ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢**: Raspberry Pi 4 / 5 (æ¨å¥¨ 4GB RAMä»¥ä¸Š) Ã— 3å°
* **OS**: Ubuntu Server 22.04 / 24.04 LTS, ã¾ãŸã¯ Raspberry Pi OS (64-bit)
* **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: å›ºå®šIPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨
* **Ansibleå®Ÿè¡Œç’°å¢ƒ**: å®Ÿè¡Œå…ƒã®PCã‹ã‚‰å…¨ãƒãƒ¼ãƒ‰ã¸ SSH æ¥ç¶šï¼ˆéµèªè¨¼ï¼‰ãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨

## ğŸš€ ä½¿ã„æ–¹

### 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†

`inventory.ini` ã‚’ç’°å¢ƒã«åˆã‚ã›ã¦ç·¨é›†ã—ã¾ã™ã€‚ç‰¹ã« **IPã‚¢ãƒ‰ãƒ¬ã‚¹** ã¨ **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å** ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

```ini
[all_masters]
# priority: pi-node1ã‚’ãƒã‚¹ã‚¿ãƒ¼(101)ã«ã€ä»–ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(100)ã«è¨­å®š
pi-node1 ansible_host=192.168.1.101 priority=101 state=MASTER
pi-node2 ansible_host=192.168.1.102 priority=100 state=BACKUP
pi-node3 ansible_host=192.168.1.103 priority=100 state=BACKUP

[primary_master]
pi-node1  # æœ€åˆã« init ã‚’è¡Œã†ãƒªãƒ¼ãƒ€ãƒ¼

[secondary_masters]
pi-node2  # å¾Œã‹ã‚‰ join ã™ã‚‹ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼
pi-node3

[all:vars]
ansible_user=pi
vip=192.168.1.100            # ãƒãƒ¼ãƒ‰ã¨ã¯åˆ¥ã®ç©ºãIP (ä»®æƒ³IP)
interface=eth0               # ip a ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèª (eth0, end0 ãªã©)
k8s_version=1.35
haproxy_port=8443            # API Server(6443)ã¨ã®ç«¶åˆå›é¿ç”¨ãƒãƒ¼ãƒˆ
node_ips=192.168.1.101,192.168.1.102,192.168.1.103 # å…¨ãƒãƒ¼ãƒ‰IP (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)

```

### 2. IPå›ºå®š
ãƒãƒ¼ãƒ‰ã«sshã—ãŸæ™‚ã«IPã‚’å›ºå®šã—ã¦ãã ã•ã„
å®Ÿè¡Œã™ã‚‹ã¨sshã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã‚‹ã®ã§å†åº¦å…¥ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚

```bash
sudo nmcli connection modify "netplan-eth0" \
  ipv4.addresses 192.168.1.101/24 \ # Node 1ã¯ 192.168.1.101 ãªã®ã§ã€101ã‚’ã€‚ä»–ã¯102, 103ç­‰è¨­å®šã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„
  ipv4.gateway 192.168.1.1 \
  ipv4.dns "8.8.8.8 1.1.1.1" \
  ipv4.method manual
sudo nmcli connection up "netplan-eth0"
```

### 3. ã‚¯ãƒ©ã‚¹ã‚¿æ§‹ç¯‰ (Setup)

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºã§æ§‹ç¯‰ãŒå®Œäº†ã—ã¾ã™ã€‚

```bash
ansible-playbook -i inventory.ini site.yml

```

**å‡¦ç†ã®æµã‚Œ:**

1. å…¨ãƒãƒ¼ãƒ‰ã« `common_setup.sh` ã‚’é…å¸ƒãƒ»å®Ÿè¡Œï¼ˆOSè¨­å®šã€HAProxy/Keepalivedèµ·å‹•ï¼‰ã€‚
2. Primaryãƒãƒ¼ãƒ‰ã§ `primary_init.sh` ã‚’å®Ÿè¡Œï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ä½œæˆã€ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œï¼‰ã€‚
3. ç™ºè¡Œã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ Ansible ãŒå–å¾—ã—ã€Secondaryãƒãƒ¼ãƒ‰ã¸æ¸¡ã—ã¦ `join` å®Ÿè¡Œã€‚
4. CNI (Flannel) é©ç”¨ã¨ Taint è§£é™¤ã€‚

### 4. å‹•ä½œç¢ºèª

Primaryãƒãƒ¼ãƒ‰ã«SSHã—ã€å…¨ãƒãƒ¼ãƒ‰ãŒ `Ready` ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```bash
ssh ubuntu@192.168.1.101
sudo kubectl get nodes

```

### ğŸ’¥ ã‚¯ãƒ©ã‚¹ã‚¿ã®ç ´å£Š (Reset)

ã‚„ã‚Šç›´ã—ãŸã„å ´åˆã‚„ã€ç’°å¢ƒã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
`kubeadm reset` ã‚„å„ç¨®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã€iptables ã®ã‚¯ãƒªã‚¢ã‚’è¡Œã„ã¾ã™ã€‚

```bash
ansible-playbook -i inventory.ini reset.yml

```

## âš™ï¸ æŠ€è¡“çš„ãªè©³ç´°

* **API ã‚¢ã‚¯ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼**:
`User/Worker` -> `VIP (192.168.1.100:8443)` -> `HAProxy (Leader Node)` -> `API Server (:6443)` (Round Robin)
* **Tokenç®¡ç†**:
`kubeadm init` æ™‚ã«ç”Ÿæˆã•ã‚Œã‚‹è¨¼æ˜æ›¸ã‚­ãƒ¼ (`certificate-key`) ã¯2æ™‚é–“ã§æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã™ãŒã€æœ¬ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å®Ÿè¡Œã®ãŸã³ã« `upload-certs` ã§æ–°ã—ã„ã‚­ãƒ¼ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ã€ã„ã¤ã§ã‚‚ãƒãƒ¼ãƒ‰è¿½åŠ ãŒå¯èƒ½ã§ã™ã€‚



## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ (Testing)

æ§‹ç¯‰ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ã€HAï¼ˆé«˜å¯ç”¨æ€§ï¼‰æ§‹æˆãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ã‚’è‡ªå‹•ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã® Playbook (`verify.yml`) ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

### âœ… ãƒ†ã‚¹ãƒˆå†…å®¹

`verify.yml` ã¯ä»¥ä¸‹ã®é …ç›®ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

1. **Node Status**: 3å°å…¨ã¦ã®ãƒãƒ¼ãƒ‰ãŒ `Ready` çŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã‹ï¼ˆãƒªãƒˆãƒ©ã‚¤å¾…æ©Ÿã‚ã‚Šï¼‰ã€‚
2. **Pod Health**: `kube-system` å†…ã®å¿…é ˆ Pod (CNI, CoreDNSç­‰) ãŒå…¨ã¦ `Running` ã‹ã€‚
3. **HA / VIP Check**: ä»®æƒ³IP (`VIP`) çµŒç”±ã§ API Server ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ï¼ˆKeepalived & HAProxy ã®å‹•ä½œç¢ºèªï¼‰ã€‚

---

### ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ (Vagrant)

å®Ÿæ©Ÿã‚’ä½¿ã‚ãšã«ã€PCä¸Šã®ä»®æƒ³ãƒã‚·ãƒ³ã§æ§‹ç¯‰ã¨ãƒ†ã‚¹ãƒˆã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

#### å‰ææ¡ä»¶

* [VirtualBox](https://www.virtualbox.org/)
* [Vagrant](https://www.vagrantup.com/)

```bash
brew install ansible
brew install virtualbox
brew install vagrant
```

#### å®Ÿè¡Œæ‰‹é †

1. **ä»®æƒ³ãƒã‚·ãƒ³ã®èµ·å‹•**
```bash
vagrant up

```


Debian(trixy)ã®ä»®æƒ³ã‚µãƒ¼ãƒãƒ¼ãŒ3å°èµ·å‹•ã—ã¾ã™ã€‚
2. **æ§‹ç¯‰ã®å®Ÿè¡Œ**
ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ« (`inventory_vagrant.ini`) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```bash
ansible-playbook -i inventory_vagrant.ini site.yml

```

3. **æ¤œè¨¼ã®å®Ÿè¡Œ**
```bash
ansible-playbook -i inventory_vagrant.ini verify.yml

```

**å‡ºåŠ›çµæœ:**
* æˆåŠŸæ™‚: ç·‘è‰²ã®æ–‡å­—ã§ `âœ… OK: All 3 nodes are Ready.` ç­‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
* å¤±æ•—æ™‚: èµ¤è‰²ã®æ–‡å­—ã§ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ï¼ˆä¾‹: VIPã«ç¹‹ãŒã‚‰ãªã„ã€PodãŒèµ·å‹•ã—ã¦ã„ãªã„ï¼‰ãŒé€šçŸ¥ã•ã‚Œã¾ã™ã€‚


4. **ç’°å¢ƒã®ç ´æ£„**
ãƒ†ã‚¹ãƒˆãŒçµ‚ã‚ã£ãŸã‚‰ç’°å¢ƒã‚’å‰Šé™¤ã—ã¾ã™ã€‚
```bash
vagrant destroy -f

```



---

### ğŸ“ å®Ÿæ©Ÿ (Raspberry Pi) ã§ã®æ¤œè¨¼

å®Ÿæ©Ÿã¸ã®æ§‹ç¯‰ (`site.yml`) å®Œäº†å¾Œã€åŒæ§˜ã« `verify.yml` ã‚’å®Ÿè¡Œã—ã¦å¥å…¨æ€§ã‚’ç¢ºèªã§ãã¾ã™ã€‚
ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬ç•ªç”¨ (`inventory.ini`) ã«åˆ‡ã‚Šæ›¿ãˆã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```bash
ansible-playbook -i inventory.ini verify.yml

```



æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚å…ˆã»ã©ã®è­°è«–ã«åŸºã¥ã„ãŸ**ã€ŒKubernetes ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹é †ã€**ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ã“ã‚Œã‚’ `README.md` ã®æœ«å°¾ï¼ˆã¾ãŸã¯é‹ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

ã¾ãŸã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® **`upgrade.yml`** ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å®Ÿéš›ã«å¿…è¦ã«ãªã‚‹ãŸã‚ã€READMEã®ä¸‹ã«ã‚³ãƒ¼ãƒ‰ã‚‚è¼‰ã›ã¦ãŠãã¾ã™ï¼ˆã¾ã ä½œæˆã—ã¦ã„ãªã‘ã‚Œã°ã€`site.yml` ã¨åŒã˜å ´æ‰€ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰ã€‚

---

## ğŸ”„ Kubernetes ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹é † (Upgrade Procedure)

Ansible ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’åœæ­¢ã•ã›ã‚‹ã“ã¨ãªã **ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆ1å°ãšã¤æ›´æ–°ï¼‰** ã‚’è¡Œã„ã¾ã™ã€‚

### âš ï¸ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®é‰„å‰‡
1.  **é£›ã³ç´šç¦æ­¢**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å¿…ãšã€Œ1ã¤ãšã¤ã€ä¸Šã’ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹: `1.31` â†’ `1.32` ã¯OKã€‚`1.31` â†’ `1.33` ã¯NGï¼‰
2.  **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: ä½œæ¥­å‰ã«å¿…ãš Etcd ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
3.  **ãƒªãƒã‚¸ãƒˆãƒªæ›´æ–°**: Kubernetes ã® apt ãƒªãƒã‚¸ãƒˆãƒª (`pkgs.k8s.io`) ã¯ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã« URL ãŒç•°ãªã‚Šã¾ã™ã€‚äº‹å‰ã«è¨­å®šå¤‰æ›´ãŒå¿…è¦ã§ã™ã€‚

### å®Ÿè¡Œæ‰‹é †

#### 1. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç¢ºèª
ç¾åœ¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å…ˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ç‰¹å®šã—ã¾ã™ã€‚
```bash
# ä»»æ„ã®ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œ
apt-cache madison kubeadm
# å‡ºåŠ›ä¾‹: 1.32.0-1.1 ... -> ã“ã® "1.32.0-1.1" ã‚’ãƒ¡ãƒ¢ã™ã‚‹

```

#### 2. ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°

`inventory.ini` (ã¾ãŸã¯ `inventory_vagrant.ini`) å†…ã® `k8s_version` å¤‰æ•°ã‚’ã€æ–°ã—ã„ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: `1.32`ï¼‰ã«æ›¸ãæ›ãˆã¾ã™ã€‚

```ini
# inventory.ini
k8s_version=1.32  # <--- ã“ã“ã‚’æ›´æ–°

```

#### 3. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç”¨ Playbook ã®å®Ÿè¡Œ

`upgrade.yml` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`-e target_version=...` ã§å…·ä½“çš„ãªãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```bash
# æ§‹æ–‡: ansible-playbook -i <ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª> upgrade.yml -e "target_version=<ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·>"

# ä¾‹: å®Ÿæ©Ÿã‚’ v1.32.0-1.1 ã«ä¸Šã’ã‚‹å ´åˆ
ansible-playbook -i inventory.ini upgrade.yml -e "target_version=1.32.0-1.1"

```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Ansible ãŒä»¥ä¸‹ã®å‡¦ç†ã‚’1ãƒãƒ¼ãƒ‰ãšã¤é †æ¬¡å®Ÿè¡Œã—ã¾ã™ã€‚

1. **Drain**: ãƒãƒ¼ãƒ‰ä¸Šã® Pod ã‚’ä»–ã¸é€€é¿
2. **Repo Update**: apt ãƒªãƒã‚¸ãƒˆãƒªã‚’æ›´æ–°
3. **Upgrade**: kubeadm / kubelet / kubectl ã‚’æ›´æ–°
4. **Uncordon**: ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«å¾©å¸°
