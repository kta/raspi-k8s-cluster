apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: atlantis
  namespace: argocd
  annotations:
    # 最後にデプロイ
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default

  source:
    repoURL: https://runatlantis.github.io/helm-charts
    chart: atlantis
    targetRevision: 5.10.0
    helm:
      releaseName: atlantis
      valuesObject:
        # GitHub 連携設定
        orgAllowlist: "github.com/YOUR_USERNAME/*"

        github:
          user: YOUR_USERNAME
          # Phase 2 で作成した Secret を参照
          secret: atlantis-github-secret
          secretKey: token

        # Webhook Secret（GitHub Webhook 設定時に使用）
        # webhookSecret: "your-webhook-secret"

        # サービス設定
        service:
          type: NodePort
          nodePort: 30141

        # リソース制限（Raspberry Pi 向け）
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

        # リポジトリ設定
        repoConfig: |
          ---
          repos:
            - id: github.com/YOUR_USERNAME/raspi-k8s-cluster
              branch: /.*/
              allowed_overrides: [workflow, apply_requirements]
              allow_custom_workflows: true

        # Atlantis サーバー設定
        atlantisUrl: http://atlantis.local:30141

  destination:
    server: https://kubernetes.default.svc
    namespace: atlantis

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true